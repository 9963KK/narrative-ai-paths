# TODO 任务清单

## 🚀 当前优先级任务

### ✅ 已完成：API Key记忆功能

- **目标**：避免每次刷新都需要重新输入API Key
- **实现内容**：
  - ✅ 创建配置存储服务 (`src/services/configStorage.ts`)
  - ✅ 添加API Key加密/解密功能
  - ✅ 更新ModelConfig组件支持自动保存/加载
  - ✅ 添加配置状态显示和清除功能
  - ✅ 集成到StoryManager中自动加载保存的配置
  - ✅ 修复配置警告显示逻辑，避免已配置时仍显示警告
  - ✅ 优化清除配置功能：清除时同时清空表单并禁用保存按钮

### 1. 角色系统更新

- **目标**：确保故事进行中的角色信息被正确载入和更新
- **实现细节**：
  - 扩展 `StoryState`接口，增加角色动态更新字段
  - 修改 `StoryManager`中的角色处理逻辑
  - 添加角色状态持久化功能
- **关联文件**：
  - `src/components/StoryManager.tsx`
  - `src/services/storyAI.ts`

### ✅ 已完成：上下文管理系统升级

- **目标**：实现故事上下文保存和历史对话管理
- **实现内容**：
  - ✅ 创建 `contextManager`核心服务 (`src/services/contextManager.ts`)
  - ✅ 设计完整的上下文数据结构和接口
  - ✅ 集成到 `StoryManager`组件中
  - ✅ 实现本地存储加密功能
  - ✅ 创建存档管理UI组件 (`src/components/SaveManager.tsx`)
  - ✅ 在 `StoryReader`中添加保存和存档管理按钮
  - ✅ 实现自动保存机制（每章节完成后自动保存）
  - ✅ 支持多故事并行管理
  - ✅ 添加存档元数据管理（标题、时间、进度等）
  - ✅ **首页存档管理入口**：在主界面添加存档管理选项
  - ✅ **详细进度显示**：显示章节进度、游戏时长、角色数量
  - ✅ **可视化进度条**：直观显示故事完成度
  - ✅ **三列布局优化**：简单配置、存档管理、高级配置
  - ✅ **首页存档预览**：从首页直接查看和加载所有存档
- **新增功能**：
  - 手动保存故事进度
  - 自动保存在关键节点
  - 存档列表查看和管理
  - 故事进度恢复
  - 对话历史完整保存
  - 🆕 首页存档入口和快速访问
  - 🆕 可视化故事进度展示
  - 🆕 卡片式存档浏览
  - 🆕 一键继续游戏功能

## ✅ 已完成：文档分析功能

- **目标**：实现小说文档上传分析，AI提取创作元素
- **实现内容**：
  - ✅ 创建文档分析服务 (`src/services/documentAnalyzer.ts`)
  - ✅ 实现多格式文件支持（TXT、PDF、DOCX、MD、RTF）
  - ✅ AI智能分析：角色识别、背景设定、主题分析、写作风格
  - ✅ 创建文档分析组件 (`src/components/DocumentAnalyzer.tsx`)
  - ✅ 拖拽上传界面和分析结果可视化展示
  - ✅ 集成到故事初始化流程中
  - ✅ 在主页面添加"文档分析"选项卡
  - ✅ 支持基于分析结果自动填充高级配置
  - ✅ 在AI故事生成中集成文档分析参考
  - ✅ 界面布局优化（调整卡片位置顺序）
  - ✅ 高级配置页面滚动体验优化
- **核心功能**：
  - **角色分析**：自动识别人物角色、性格特点、关系网络
  - **背景设定**：提取时间、地点、世界观、氛围
  - **主题元素**：分析故事主题、冲突、情节设备
  - **风格特征**：识别叙述视角、语调、文体风格
  - **创意种子**：生成基于原作的故事创意
- **技术特点**：
  - 支持多种AI模型（OpenAI、Anthropic、DeepSeek等）
  - 3次重试机制确保分析成功率
  - 智能内容截取处理长文档
  - 温度控制保证分析准确性

## 🚀 **新增：下一代功能开发计划**

### 📊 **计划1：流式输出系统** 

**可行性：高 ⭐⭐⭐⭐⭐**

- **目标**：对 `generateNextChapter` 实现流式输出，提升用户体验
- **技术方案**：
  ```typescript
  // 分阶段流式输出
  interface StreamResponse {
    type: 'scene_chunk' | 'scene_complete' | 'choices';
    content: string | Choice[];
    isComplete: boolean;
  }
  
  async function* generateNextChapterStream(storyState, choice) {
    // 第一阶段：流式输出故事场景
    for await (const chunk of streamStoryScene(storyState, choice)) {
      yield { type: 'scene_chunk', content: chunk, isComplete: false };
    }
    
    // 第二阶段：生成选择项JSON（保持现有解析逻辑）
    const choices = await this.generateChoices(...);
    yield { type: 'choices', content: choices, isComplete: true };
  }
  ```

- **实现计划**：
  - 🥇 **第一步**：修改 `callAI` 方法支持 `stream: true` 参数
  - 🥈 **第二步**：创建流式输出组件（前端 EventSource 处理）
  - 🥉 **第三步**：保持现有JSON解析逻辑不变，仅对scene部分使用流式输出

- **预期收益**：
  - ⚡ 减少用户等待时间的心理感受
  - 📝 实时看到故事生成过程，提升代入感
  - 🎬 更流畅的阅读体验

- **工期估算**：3-5天
- **风险评估**：中等（需要前后端配合，但技术成熟）

### 🔄 **计划2：上下文裁剪系统**

**可行性：中高 ⭐⭐⭐⭐**

#### **2.1 滑动窗口实现（优先级：高）**

- **目标**：维持最近N轮对话，立即控制token消耗
- **技术方案**：
  ```typescript
  class ContextManager {
    private maxContextLength = 10; // 保持最近10轮对话
    
    trimContext(history: ConversationHistory[]): ConversationHistory[] {
      if (history.length <= this.maxContextLength) return history;
      
      // 策略：保留系统消息 + 最新对话
      const systemMessages = history.filter(h => h.role === 'system');
      const recentMessages = history.slice(-this.maxContextLength);
      
      return [...systemMessages.slice(0, 2), ...recentMessages];
    }
  }
  ```

- **实现细节**：
  - 基于现有 `conversationHistory` 扩展
  - 智能保留重要系统消息
  - 可配置窗口大小
  - 实时token计算和显示

- **预期收益**：
  - 💰 立即降低API调用成本
  - ⚡ 提升响应速度
  - 📊 更可控的上下文管理

- **工期估算**：1-2天
- **风险评估**：低

#### **2.2 智能摘要维护（优先级：中）**

- **目标**：后台维护历史对话摘要，保留关键信息
- **技术架构**：
  ```typescript
  interface ContextStrategy {
    summary: string;           // 历史摘要
    recentHistory: Message[];  // 最近对话窗口  
    keyEvents: string[];       // 关键事件记录
    characters: Character[];   // 角色状态
  }
  
  class SummaryManager {
    // 触发条件：每5-8轮对话
    async maintainSummary() {
      if (this.shouldGenerateSummary()) {
        const summary = await this.generateSummary(this.getOldContext());
        this.contextSummary = this.mergeSummaries(this.contextSummary, summary);
      }
    }
    
    // 摘要质量控制
    private async generateSummary(history: ConversationHistory[]): Promise<string> {
      const prompt = `请总结以下对话的核心信息，重点保留：
      1. 关键剧情发展和重要事件
      2. 角色关系变化和成长
      3. 重要选择及其后果
      4. 故事氛围和情感转折`;
      
      return await this.callAI(prompt, '摘要专用系统提示');
    }
  }
  ```

- **技术挑战**：
  - 🎯 **摘要触发时机**：何时生成？如何平衡频率？
  - 📊 **信息损失控制**：确保关键信息不丢失
  - 💾 **持久化策略**：摘要如何存储和更新？
  - 🔄 **异步处理**：后台摘要不影响主流程

- **实现策略**：
  - 渐进式实现：先完成基础摘要，再优化质量
  - 多层摘要：近期详细摘要 + 远期概括摘要
  - 关键事件标记：重要选择和转折点单独记录

- **工期估算**：1-2周
- **风险评估**：中高（摘要质量控制有挑战）

### 📋 **实施路线图**

#### **🥇 第一阶段：立即实施（1-2天）**
- ✅ 实现滑动窗口上下文裁剪
- ✅ 添加token计数显示
- ✅ 基础性能优化

#### **🥈 第二阶段：用户体验提升（3-5天）**
- 🔄 实现流式输出（scene部分）
- 🔄 优化前端流式数据处理
- 🔄 保持JSON解析系统稳定

#### **🥉 第三阶段：深度优化（1-2周）**
- 🔮 智能摘要系统
- 🔮 多层上下文管理
- 🔮 性能监控和优化

### 🎯 **技术要点**

**流式输出关键点：**
- 保持现有JSON解析逻辑不变（符合用户要求）
- 仅对story scene使用流式输出
- 前端使用EventSource或fetch stream接收
- 后端支持SSE (Server-Sent Events)

**上下文管理关键点：**
- 滑动窗口优先实现（低风险高收益）
- 摘要系统逐步完善（质量控制是重点）
- 与现有conversationHistory无缝集成
- 支持配置化管理（窗口大小、摘要频率等）

### 📊 **预期效果评估**

| 功能 | 用户体验提升 | 性能优化 | 开发复杂度 | 推荐优先级 |
|------|------------|----------|------------|------------|
| 滑动窗口 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ | 🥇 高 |
| 流式输出 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 🥈 中高 |
| 智能摘要 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 🥉 中 |

### ⚠️ **注意事项**

1. **JSON解析系统**：严格遵循"不随便修改"原则，保持系统稳定性
2. **渐进式开发**：优先实现低风险高收益功能
3. **向后兼容**：确保新功能不影响现有用户体验
4. **性能监控**：添加必要的性能指标和监控
5. **测试策略**：每个阶段都需要充分测试

---

## 📅 基于小说上传功能的开发计划

### ✅ 阶段一：文件处理基础设施 (已完成)

- [X] 实现文件上传组件（集成在DocumentAnalyzer中）
- [X] 开发文件解析服务 (`documentAnalyzer.ts`)
- [X] 创建进度指示器和状态展示

### ✅ 阶段二：AI内容分析引擎 (已完成)

- [X] 实现角色识别和分析功能
- [X] 开发故事元素提取逻辑
- [X] 构建写作风格分析模块
- [X] 集成多模型AI分析能力

### ✅ 阶段三：配置生成和用户界面 (已完成)

- [X] 创建分析结果展示组件
- [X] 实现自动配置填充功能
- [X] 集成到故事生成流程

### ✅ 阶段四：系统集成和优化 (已完成)

- [X] 将分析结果集成到 `StoryManager`
- [X] 实现分析结果在故事生成中的应用
- [X] 优化界面和用户体验

## 🔮 未来功能增强计划

### 文档分析功能深化

- [ ] 支持更多文件格式（EPUB、MOBI等电子书格式）
- [ ] 实现PDF OCR文字识别能力
- [ ] 添加分析结果导出功能（JSON、PDF报告）
- [ ] 支持批量文档分析
- [ ] 实现分析模板自定义功能

### 高级分析功能

- [ ] 情感分析和情节张力曲线
- [ ] 角色关系网络图生成
- [ ] 写作技巧和文学手法识别
- [ ] 多语言文档分析支持

## 🔄 集成任务

### 角色系统与小说分析的整合

- [ ] 使AI生成的角色能无缝融入现有角色系统
- [ ] 确保角色动态更新与小说分析结果同步

### 上下文管理与历史对话

- [ ] 将小说分析上下文纳入全局上下文管理
- [ ] 实现分析历史记录功能

## ⚠️ 注意事项

1. 所有临时测试文件需在测试完成后删除（用户规则）
2. 优先保证现有功能的稳定性
3. 新功能开发需通过单元测试
4. **JSON解析系统不要随便修改** - 保持系统稳定性

## 📌 版本规划

- ✅ v1.1: 角色系统和上下文管理更新 (已完成)
- ✅ v1.2: 基础小说上传功能 (已完成)
- ✅ v1.3: 完整小说分析能力 (已完成)
- 🔄 v1.4: 用户体验优化和高级功能扩展 (进行中)
- 🚀 v1.5: 流式输出和智能上下文管理 (规划中)

---

## 📝 个人备注区

> 这里是你的个人想法和备注空间，可以随时记录灵感、问题或改进建议

  ### 💡 想法收集
  
  - 在文档解析这个模块，现阶段采用的策略是把文本内容全部传送给大模型进行处理，让大模型从这个文本中提取需要的信息，这样的优点是：
    - 传输的上下文完整，能够单次就提取系统需要的信息
    - 信息准确，可以降低大模型的幻觉
    - 单次提取的关键信息质量对于模型的依赖能力较强
  - 但是这种方法也是有缺点的：
    - 单次文本长度受限，不支持长篇内容的提取
    - 小说内容较为丰富时，难以梳理人物关系图谱和事件发展脉络
  - 所以后续的优化方向
    - 增加长篇文档的支持（构建人物事件图、构建人物关系图谱、上下文压缩等等工作）🌟
    - 增加对不同格式文档的支持，比如 pdf、epub 等等
  
  ### 📝 2025年1月6日 更新记录
  - **优化了角色参数一致性**：
    - 在高级配置中添加了 `appearance`（外观描述）和 `backstory`（背景故事）字段
    - 将高级配置中的 `personality` 统一改为 `traits`，与Character接口保持一致
    - 确保文档分析结果和高级配置的角色参数结构完全一致
  - **改进了角色名称提取**：
    - 优化了AI提示词，明确要求提取文档中的真实角色姓名而非泛指词汇
    - 添加了3次重试机制，验证角色名称提取质量
    - 增强了角色数据验证和清理逻辑，确保提取信息的完整性
  - **创建了专门的文档分析结果展示界面**：
    - 新增 `DocumentAnalysisResultView.tsx` 组件，专门展示文档分析的丰富JSON数据
    - 不再复用高级配置界面，避免数据结构不匹配的问题
    - 三列布局：人物分析（左）、故事背景与情节（中）、创意种子（右）
    - 支持导出分析结果为JSON文件
    - 提供"基于此创作故事"功能，直接将分析结果转换为故事配置
  - **重构了文档分析工作流**：
    - 分析完成后跳转到专门的结果展示界面，而不是自动填充高级配置
    - 用户可以查看完整的分析结果，然后选择是否基于此创作故事
    - 提供了更清晰的用户体验和更好的数据展示效果
    - 过滤无效的角色名称（如"主角"、"男主"等泛指词汇）

### 🐛 发现的问题

### 🚀 改进建议

### 📋 临时记录

---

*最后更新时间：$(date)*
